{% extends 'base.html' %}

{% block title %}Гра на мовлення{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                    <div>
                        <div class="text-muted small">Ігри → Мовлення</div>
                        <h1 class="display-6 mb-0 fw-bold">МОВЛЕННЯ</h1>
                    </div>
                    <div class="d-flex gap-2">
                        <form id="finishForm" method="post" action="{% url 'students:game_finish' %}" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="game" value="speech">
                            <input type="hidden" name="score" id="finishScore" value="0">
                            <button id="finish" class="btn btn-success" type="submit" data-speak="Завершити">
                                <i class="bi bi-flag"></i> Завершити
                            </button>
                        </form>
                        <button id="next" class="btn btn-outline-secondary" type="button" data-speak="Наступне речення">
                            <i class="bi bi-arrow-right"></i> Далі
                        </button>
                    </div>
                </div>

                <div class="text-muted small mb-3">Натискай слова по черзі, щоб скласти речення.</div>

                <div class="p-3 rounded bg-light mb-3">
                    <div class="text-muted small mb-1">Твоє речення:</div>
                    <div id="built" class="fw-semibold" style="min-height: 32px;"></div>
                </div>

                <div id="words" class="d-flex flex-wrap gap-2"></div>

                <div class="mt-3 d-flex gap-2 flex-wrap">
                    <button id="check" class="btn btn-primary" type="button" data-speak="Перевірити">
                        Перевірити
                    </button>
                    <button id="clear" class="btn btn-outline-secondary" type="button" data-speak="Очистити">
                        Очистити
                    </button>
                    <div id="msg" class="ms-auto text-muted"></div>
                </div>

                <div class="mt-4 d-grid d-md-flex gap-2">
                    <a class="btn btn-outline-secondary" href="{% url 'students:games' %}"
                        data-speak="Повернутися до списку ігор">
                        <i class="bi bi-arrow-left"></i> Назад
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const sentences = [
            'Я люблю читати книги',
            'Ми граємо у цікаву гру',
            'Сонце світить яскраво',
            'Кіт спить на ліжку'
        ];

        const builtEl = document.getElementById('built');
        const wordsEl = document.getElementById('words');
        const msgEl = document.getElementById('msg');
        const nextBtn = document.getElementById('next');
        const finishBtn = document.getElementById('finish');
        const finishForm = document.getElementById('finishForm');
        const finishScore = document.getElementById('finishScore');
        const checkBtn = document.getElementById('check');
        const clearBtn = document.getElementById('clear');

        let idx = 0;
        let target = '';
        let built = [];

        let checkedCount = 0;
        let correctCount = 0;

        function shuffle(a) {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function render() {
            target = sentences[idx % sentences.length];
            built = [];
            builtEl.textContent = '';
            msgEl.textContent = '';

            checkedCount = 0;
            correctCount = 0;

            const words = target.split(' ');
            const shuffled = shuffle([...words]);
            wordsEl.innerHTML = '';

            shuffled.forEach((w) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-light';
                btn.textContent = w;
                btn.setAttribute('data-speak', w);
                btn.addEventListener('click', () => {
                    if (btn.disabled) return;
                    built.push(w);
                    builtEl.textContent = built.join(' ');
                    btn.disabled = true;
                    btn.classList.remove('btn-light');
                    btn.classList.add('btn-secondary');
                });
                wordsEl.appendChild(btn);
            });
        }

        checkBtn.addEventListener('click', () => {
            checkedCount += 1;
            if (built.join(' ') === target) {
                correctCount += 1;
                msgEl.className = 'ms-auto text-success fw-semibold';
                msgEl.textContent = 'Правильно!';
            } else {
                msgEl.className = 'ms-auto text-danger fw-semibold';
                msgEl.textContent = 'Спробуй ще раз.';
            }
        });

        clearBtn.addEventListener('click', render);
        nextBtn.addEventListener('click', () => { idx += 1; render(); });

        function computeScore() {
            if (checkedCount <= 0) return 0;
            return Math.round((correctCount / checkedCount) * 100);
        }

        if (finishForm) {
            finishForm.addEventListener('submit', () => {
                if (finishScore) finishScore.value = String(computeScore());
            });
        }

        render();
    })();
</script>
{% endblock %}