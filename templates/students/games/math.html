{% extends 'base.html' %}

{% block title %}Математична гра{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-body p-4 p-md-5">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
                    <div>
                        <div class="text-muted small">Ігри → Математика</div>
                        <h1 class="display-6 mb-0 fw-bold">МАТЕМАТИКА</h1>
                    </div>
                    <div class="d-flex gap-2">
                        <form id="finishForm" method="post" action="{% url 'students:game_finish' %}" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="game" value="math">
                            <input type="hidden" name="score" id="finishScore" value="0">
                            <button id="finish" class="btn btn-success" type="submit" data-speak="Завершити">
                                <i class="bi bi-flag"></i> Завершити
                            </button>
                        </form>
                        <button id="new" class="btn btn-outline-secondary" type="button" data-speak="Нове завдання">
                            <i class="bi bi-arrow-repeat"></i> Нове
                        </button>
                    </div>
                </div>

                <div class="text-muted small mb-3">Обери правильну відповідь.</div>

                <div class="p-3 rounded bg-light mb-3">
                    <div class="text-muted small">Приклад</div>
                    <div class="display-6 fw-bold" id="task">—</div>
                </div>

                <div class="row g-3">
                    <div class="col-12 col-md-4"><button class="btn btn-light btn-lg w-100 kid-tile" data-ans="0"
                            type="button"></button></div>
                    <div class="col-12 col-md-4"><button class="btn btn-light btn-lg w-100 kid-tile" data-ans="1"
                            type="button"></button></div>
                    <div class="col-12 col-md-4"><button class="btn btn-light btn-lg w-100 kid-tile" data-ans="2"
                            type="button"></button></div>
                </div>

                <div class="mt-3 d-flex justify-content-between flex-wrap gap-2">
                    <div class="text-muted">Рахунок: <span id="score" class="fw-semibold">0</span></div>
                    <div id="msg" class="text-muted"></div>
                </div>

                <div class="mt-4 d-grid d-md-flex gap-2">
                    <a class="btn btn-outline-secondary" href="{% url 'students:games' %}"
                        data-speak="Повернутися до списку ігор">
                        <i class="bi bi-arrow-left"></i> Назад
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const taskEl = document.getElementById('task');
        const scoreEl = document.getElementById('score');
        const msgEl = document.getElementById('msg');
        const newBtn = document.getElementById('new');
        const finishBtn = document.getElementById('finish');
        const finishForm = document.getElementById('finishForm');
        const finishScore = document.getElementById('finishScore');
        const buttons = Array.from(document.querySelectorAll('button[data-ans]'));

        let score = 0;
        let correct = 0;

        function randint(a, b) {
            return Math.floor(Math.random() * (b - a + 1)) + a;
        }

        function shuffle(a) {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function newTask() {
            msgEl.className = 'text-muted';
            msgEl.textContent = '';

            const a = randint(1, 9);
            const b = randint(1, 9);
            correct = a + b;

            const opts = new Set([correct]);
            while (opts.size < 3) {
                opts.add(correct + randint(-3, 3));
            }
            const arr = shuffle(Array.from(opts)).map(x => Math.max(0, x));

            taskEl.textContent = `${a} + ${b} = ?`;
            buttons.forEach((btn, i) => {
                btn.disabled = false;
                btn.classList.remove('btn-success', 'btn-danger');
                btn.classList.add('btn-light');
                btn.textContent = String(arr[i]);
                btn.dataset.value = String(arr[i]);
                btn.setAttribute('data-speak', btn.textContent);
            });
        }

        buttons.forEach((btn) => {
            btn.addEventListener('click', () => {
                const val = parseInt(btn.dataset.value || '0', 10);
                buttons.forEach(b => b.disabled = true);
                if (val === correct) {
                    score += 1;
                    scoreEl.textContent = String(score);
                    btn.classList.remove('btn-light');
                    btn.classList.add('btn-success');
                    msgEl.className = 'text-success fw-semibold';
                    msgEl.textContent = 'Правильно!';
                } else {
                    btn.classList.remove('btn-light');
                    btn.classList.add('btn-danger');
                    msgEl.className = 'text-danger fw-semibold';
                    msgEl.textContent = 'Неправильно.';
                }
                setTimeout(newTask, 900);
            });
        });

        newBtn.addEventListener('click', newTask);

        function computeScore() {
            // Convert correct answers to 0..100 scale (10 correct => 100)
            return Math.min(100, Math.max(0, score * 10));
        }

        if (finishForm) {
            finishForm.addEventListener('submit', () => {
                if (finishScore) finishScore.value = String(computeScore());
            });
        }
        newTask();
    })();
</script>
{% endblock %}